<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Protect LPR Imaging - Configuratie</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f7f7f7; }
        .container { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 32px; }
        h1 { text-align: center; color: #2c3e50; }
        form { margin-top: 24px; }
        label { display: block; margin-top: 16px; font-weight: bold; }
        input[type="text"], input[type="number"] { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; margin-top: 4px; }
        textarea { width: 100%; min-height: 60px; font-family: monospace; font-size: 14px; border-radius: 4px; border: 1px solid #ccc; padding: 8px; }
        input[type="submit"], button { margin-top: 16px; padding: 8px 16px; border-radius: 4px; border: none; background: #2c3e50; color: #fff; cursor: pointer; }
        .msg { color: green; text-align: center; }
        .err { color: red; text-align: center; }
        a { display: inline-block; margin-top: 16px; color: #2c3e50; }
        .section { margin-bottom: 32px; }
        .inline-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 4px; }
        .inline-list input[type="text"] { width: auto; flex: 1; }
        .inline-list button { padding: 4px 8px; }
        .rtsp-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
        .rtsp-table th, .rtsp-table td { border: 1px solid #ccc; padding: 6px 8px; text-align: left; }
        .rtsp-table th { background: #f0f0f0; }
        .rtsp-table input, .rtsp-table select { width: 100%; }
        .rtsp-actions { display: flex; gap: 8px; }
        .add-btn { background: #27ae60; }
        .del-btn { background: #c0392b; }
    </style>
    <script>
    // Escape HTML for safe value insertion
    function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;')
                  .replace(/"/g, '&quot;')
                  .replace(/'/g, '&#39;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;');
    }

    function addPlateRow() {
        var input = document.getElementById('new-plate-input');
        var commentInput = document.getElementById('new-plate-comment');
        var plate = input.value.trim();
        var comment = commentInput.value.trim();
        if (!plate) return;
        // Check if already exists
        var exists = false;
        document.querySelectorAll('input[name="ignored_plates[]"]')
            .forEach(function(el) { if (el.value.trim() === plate) exists = true; });
        if (exists) return;
        var row = document.createElement('div');
        row.className = 'ignored-plate-row';
        row.style = 'display: flex; align-items: center; gap: 8px;';
        row.innerHTML = `
            <input type="text" name="ignored_plates[]" value="${escapeHtml(plate)}" style="flex:1;">
            <input type="text" name="ignored_plates_comment[]" value="${escapeHtml(comment)}" placeholder="Opmerking" style="flex:1;">
            <span class="event-count" style="color:#888; font-size:13px; min-width:80px;">Events: ...</span>
            <button type="button" class="del-btn" onclick="removePlateRow(this)">Verwijder</button>
        `;
        document.getElementById('ignored-plates-list').appendChild(row);
        input.value = '';
        commentInput.value = '';
        // --- IMPORTANT: Wait for DOM update before autosave ---
        setTimeout(function() {
            // Collect form data for debug
            var form = document.getElementById('config-form');
            var formData = new FormData(form);
            var debugData = {};
            formData.forEach(function(value, key) {
                if (key.endsWith('[]')) {
                    var k = key.slice(0, -2);
                    if (!debugData[k]) debugData[k] = [];
                    debugData[k].push(value);
                } else {
                    debugData[key] = value;
                }
            });
            // Print debug info to the screen
            var debugDiv = document.getElementById('debug-postdata');
            if (!debugDiv) {
                debugDiv = document.createElement('pre');
                debugDiv.id = 'debug-postdata';
                debugDiv.style = 'background:#ffeeba;color:#222;padding:8px 12px;margin:10px 0 20px 0;border-radius:6px;border:1px solid #ffeeba;max-width:100%;overflow-x:auto;';
                document.querySelector('.container').prepend(debugDiv);
            }
            debugDiv.textContent = 'POST data:\n' + JSON.stringify(debugData, null, 2);
            autoSaveConfig();
        }, 50);
        // Fetch event count for this plate
        fetch('/config/event_count?plate=' + encodeURIComponent(plate))
            .then(resp => {
                if (!resp.ok) throw new Error('Network response was not ok');
                return resp.json();
            })
            .then(data => {
                var count = (data && typeof data.count === 'number') ? data.count : 0;
                row.querySelector('.event-count').innerText = 'Events: ' + count;
            })
            .catch(() => {
                row.querySelector('.event-count').innerText = 'Events: ?';
            });
    }

    function removePlateRow(btn) {
        var row = btn.closest('.ignored-plate-row');
        if (row) row.remove();
        autoSaveConfig();
    }

    function autoSaveConfig() {
        var form = document.getElementById('config-form');
        var formData = new FormData(form);
        var data = {};
        formData.forEach(function(value, key) {
            if (key.endsWith('[]')) {
                var k = key.slice(0, -2);
                if (!data[k]) data[k] = [];
                data[k].push(value);
            } else {
                data[key] = value;
            }
        });
        // Explicitly add log_level from the dropdown (in case browser doesn't include it)
        var logLevelSelect = document.getElementById('log_level');
        if (logLevelSelect) {
            data['log_level'] = logLevelSelect.value;
        }
        fetch('/config/auto_save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
            body: JSON.stringify(data)
        })
        .then(resp => resp.json())
        .then(data => {
            if (data.success) {
                showTempMsg('Configuratie opgeslagen', 'msg');
            } else {
                showTempMsg('Fout bij opslaan: ' + (data.msg || 'Onbekend'), 'err');
            }
        })
        .catch(() => {
            showTempMsg('Fout bij opslaan van configuratie', 'err');
        });
    }

    function showTempMsg(msg, cls) {
        var div = document.createElement('div');
        div.className = cls;
        div.innerText = msg;
        document.querySelector('.container').prepend(div);
        setTimeout(() => { div.remove(); }, 2000);
    }
    </script>
</head>
<body>
    <div class="container">
        <div style="text-align:right;">
            <a href="/">Terug naar overzicht</a>
            |
            <a href="/config/users">Gebruikersbeheer</a>
        </div>
        <h1>Configuratie aanpassen</h1>
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="{{ category }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}
        <form method="post" id="config-form">
            <div class="section">
                <label>Log directory</label>
                <input type="text" name="log_dir" value="{{ config['paths']['log_dir'] }}">
                <label>Image directory</label>
                <input type="text" name="image_dir" value="{{ config['paths']['image_dir'] }}">
            </div>
            <div class="section">
                <label>Sqlite3 DB file</label>
                <input type="text" name="sqlite3_db_file" value="{{ config['sqlite3_db_file'] if config.get('sqlite3_db_file') else config['paths']['mysql_db_file'] }}">
                <label>Users file</label>
                <input type="text" name="users_file" value="{{ config['users_file'] }}">
            </div>
            <div class="section">
                <label>Genegeerde kentekens (Ignored plates)</label>
                <div id="ignored-plates-list" class="inline-list" style="flex-direction: column; gap: 6px;">
                    {% for plate_obj in normalized_plates %}
                    <div class="ignored-plate-row" style="display: flex; align-items: center; gap: 8px;">
                        <input type="text" name="ignored_plates[]" value="{{ plate_obj.plate }}" style="flex:1;">
                        <input type="text" name="ignored_plates_comment[]" value="{{ plate_obj.comment }}" placeholder="Opmerking" style="flex:1;">
                        <span class="event-count" style="color:#888; font-size:13px; min-width:80px;">
                            <a href="/config/purge_plate/{{ plate_obj.plate }}">Events</a>: {{ plate_event_counts.get(plate_obj.plate, 0) }}
                        </span>
                        <button type="button" class="del-btn" onclick="removePlateRow(this)">Verwijder</button>
                    </div>
                    {% endfor %}
                </div>
                <div style="margin-top:8px;">
                    <input type="text" id="new-plate-input" placeholder="Nieuw kenteken" style="width:200px;">
                    <input type="text" id="new-plate-comment" placeholder="Opmerking" style="width:200px;">
                    <button type="button" class="add-btn" onclick="addPlateRow()">Voeg toe</button>
                </div>
            </div>
            <div class="section">
                <label>Webserver instellingen</label>
                <label>Port</label>
                <input type="number" name="web_port" value="{{ config['web']['port'] if config.get('web') and config['web'].get('port') else 8082 }}">
            </div>
            <div class="section">
                <label for="log_level">Log level</label>
                <select name="log_level" id="log_level" onchange="autoSaveConfig()">
                    {% set log_level = config['logging']['level'] if config.get('logging') and config['logging'].get('level') else 'INFO' %}
                    <option value="DEBUG" {% if log_level == 'DEBUG' %}selected{% endif %}>DEBUG</option>
                    <option value="INFO" {% if log_level == 'INFO' %}selected{% endif %}>INFO</option>
                    <option value="WARNING" {% if log_level == 'WARNING' %}selected{% endif %}>WARNING</option>
                    <option value="ERROR" {% if log_level == 'ERROR' %}selected{% endif %}>ERROR</option>
                    <option value="CRITICAL" {% if log_level == 'CRITICAL' %}selected{% endif %}>CRITICAL</option>
                </select>
            </div>
            <!-- Video Backup Configuration Section -->
            <div class="section">
                <label>Video Backup Instellingen</label>
                <div class="form-group">
                    <label for="backup_original_video">
                        <input type="checkbox" id="backup_original_video" name="backup_original_video"
                            {% if config.get('backup_original_video', False) %}checked{% endif %}>
                        Backup originele video
                    </label>
                </div>
                <div class="form-group">
                    <label for="video_window_start_seconds">Video window start (seconden):</label>
                    <input type="number" id="video_window_start_seconds" name="video_window_start_seconds"
                        value="{{ config.get('video_window_start_seconds', -15) }}">
                </div>
                <div class="form-group">
                    <label for="video_window_end_seconds">Video window einde (seconden):</label>
                    <input type="number" id="video_window_end_seconds" name="video_window_end_seconds"
                        value="{{ config.get('video_window_end_seconds', 20) }}">
                </div>
            </div>
            <input type="submit" value="Opslaan">
        </form>
    </div>
    <script>
        function addPlateRow() {
            var input = document.getElementById('new-plate-input');
            var commentInput = document.getElementById('new-plate-comment');
            var plate = input.value.trim();
            var comment = commentInput.value.trim();
            if (!plate) return;
            // Check if already exists
            var exists = false;
            document.querySelectorAll('input[name="ignored_plates[]"]')
                .forEach(function(el) { if (el.value.trim() === plate) exists = true; });
            if (exists) return;
            var row = document.createElement('div');
            row.className = 'ignored-plate-row';
            row.style = 'display: flex; align-items: center; gap: 8px;';
            // Default to 0, will update after AJAX
            row.innerHTML = `
                <input type="text" name="ignored_plates[]" value="${plate}" style="flex:1;">
                <input type="text" name="ignored_plates_comment[]" placeholder="Opmerking" style="flex:1;">
                <span class="event-count" style="color:#888; font-size:13px; min-width:80px;">Events: ...</span>
                <button type="button" class="del-btn" onclick="removePlateRow(this)">Verwijder</button>
            `;
            document.getElementById('ignored-plates-list').appendChild(row);
            input.value = '';
            commentInput.value = '';
            // Fetch event count for this plate
            fetch('/config/event_count?plate=' + encodeURIComponent(plate))
                .then(resp => resp.json())
                .then(data => {
                    var count = (data && typeof data.count === 'number') ? data.count : 0;
                    row.querySelector('.event-count').innerText = 'Events: ' + count;
                })
                .catch(() => {
                    row.querySelector('.event-count').innerText = 'Events: ?';
                });
            // --- AUTO-SAVE CONFIG ---
            autoSaveConfig();
        }
        function removePlateRow(btn) {
            var row = btn.closest('.ignored-plate-row');
            if (row) row.remove();
            autoSaveConfig(); // Save config after removing a plate
        }
        function autoSaveConfig() {
            var form = document.getElementById('config-form');
            var formData = new FormData(form);
            var data = {};
            formData.forEach(function(value, key) {
                if (key.endsWith('[]')) {
                    var k = key.slice(0, -2);
                    if (!data[k]) data[k] = [];
                    data[k].push(value);
                } else {
                    data[key] = value;
                }
            });
            // Explicitly add log_level from the dropdown (in case browser doesn't include it)
            var logLevelSelect = document.getElementById('log_level');
            if (logLevelSelect) {
                data['log_level'] = logLevelSelect.value;
            }
            fetch('/config/auto_save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                body: JSON.stringify(data)
            })
            .then(resp => resp.json())
            .then(data => {
                if (data.success) {
                    // Optionally show a small success message
                    showTempMsg('Configuratie opgeslagen', 'msg');
                } else {
                    showTempMsg('Fout bij opslaan: ' + (data.msg || 'Onbekend'), 'err');
                }
            })
            .catch(() => {
                showTempMsg('Fout bij opslaan van configuratie', 'err');
            });
        }
        function showTempMsg(msg, cls) {
            var div = document.createElement('div');
            div.className = cls;
            div.innerText = msg;
            document.querySelector('.container').prepend(div);
            setTimeout(() => { div.remove(); }, 2000);
        }
    </script>
</body>
</html>